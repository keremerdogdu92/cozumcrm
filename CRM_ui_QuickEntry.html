<!-- v3.7.0 -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Trial Quick Entry</title>
  <style>
    :root{--bg:#f7f9fc; --fg:#1f1f1f; --accent:#1a73e8; --mut:#6c727f; --err:#c62828; --ok:#0a8754; --bd:#d9dde4;}
    body{margin:0;padding:16px;font:14px/1.4 "Helvetica Neue",Arial,sans-serif;color:var(--fg);background:var(--bg);}
    h1{font-size:18px;margin:0 0 12px;color:var(--accent);}
    form{display:flex;flex-direction:column;gap:18px;}
    .section{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:16px;box-shadow:0 1px 2px rgba(31,41,55,.04);}
    .section h2{margin:0 0 12px;font-size:15px;color:#2d3748;}
    label{display:block;font-weight:600;font-size:13px;margin-bottom:6px;color:#2d3748;}
    input,textarea{width:100%;padding:10px;border:1px solid var(--bd);border-radius:8px;background:#fbfcff;font-size:14px;}
    textarea{min-height:72px;resize:vertical;}
    .grid{display:grid;gap:12px;}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(180px,1fr));}
    .slug-preview{font-size:12px;color:var(--mut);margin-top:4px;}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid var(--bd);padding:8px;font-size:13px;}
    th{background:#f2f4f8;text-align:left;}
    .cell-actions{text-align:center;width:54px;}
    button{cursor:pointer;border:none;border-radius:999px;padding:10px 16px;font-weight:600;background:var(--accent);color:#fff;transition:background .2s ease;}
    button[disabled]{background:#c8d2eb;cursor:not-allowed;}
    .btn-secondary{background:transparent;color:var(--accent);border:1px solid var(--accent);border-radius:8px;padding:6px 10px;font-weight:500;}
    .btn-row{margin-top:10px;display:flex;gap:12px;flex-wrap:wrap;}
    .toast{font-weight:600;min-height:20px;}
    .toast.ok{color:var(--ok);} .toast.err{color:var(--err);} .toast{margin-top:4px;}
    @media (max-width:640px){body{padding:12px;} .section{padding:14px;} button{width:100%;}}
  </style>
</head>
<body>
  <h1>Trial Quick Entry</h1>
  <form id="qeForm" onsubmit="submitForm(event)">
    <div class="section">
      <h2>Person</h2>
      <div>
        <label for="full_name">Full name</label>
        <input id="full_name" autocomplete="name" required>
        <div id="slugPreview" class="slug-preview"></div>
      </div>
      <div class="grid grid-2" style="margin-top:12px;">
        <div>
          <label for="ref">Reference</label>
          <input id="ref" required placeholder="Source (required)">
        </div>
        <div>
          <label for="phone">Phone</label>
          <input id="phone" type="tel" autocomplete="tel" required>
        </div>
      </div>
      <div style="margin-top:12px;">
        <label for="address">Address</label>
        <textarea id="address" placeholder="Optional"></textarea>
      </div>
    </div>

    <div class="section">
      <h2>Visit details</h2>
      <div class="grid grid-2">
        <div>
          <label for="initial_at">First meeting date</label>
          <input type="datetime-local" id="initial_at" required>
        </div>
        <div>
          <label for="next_at">Next meeting date</label>
          <input type="datetime-local" id="next_at" required>
        </div>
      </div>
      <div style="margin-top:12px;">
        <label for="trial_note">Note</label>
        <textarea id="trial_note" required placeholder="Visit notes"></textarea>
      </div>
      <div style="margin-top:12px;">
        <label for="payer">Payer (Kurum)</label>
        <input id="payer" required placeholder="SGK / Private / ...">
      </div>
    </div>

    <div class="section">
      <h2>Devices</h2>
      <table>
        <thead>
          <tr><th>Model</th><th>Price (Net)</th><th></th></tr>
        </thead>
        <tbody id="devicesBody"></tbody>
      </table>
      <div class="btn-row">
        <button type="button" class="btn-secondary" onclick="addDeviceRow()">Add device</button>
      </div>
    </div>

    <button id="submitBtn" type="submit">Save trial</button>
    <div id="toast" class="toast"></div>
  </form>

  <script>
    const form=document.getElementById('qeForm');
    const fullNameInput=document.getElementById('full_name');
    const refInput=document.getElementById('ref');
    const phoneInput=document.getElementById('phone');
    const addressInput=document.getElementById('address');
    const initialInput=document.getElementById('initial_at');
    const nextInput=document.getElementById('next_at');
    const noteInput=document.getElementById('trial_note');
    const payerInput=document.getElementById('payer');
    const devicesBody=document.getElementById('devicesBody');
    const submitBtn=document.getElementById('submitBtn');
    const toast=document.getElementById('toast');
    const slugPreview=document.getElementById('slugPreview');

    const ERROR_MESSAGES={
      missing_full_name:'Full name is required.',
      missing_ref:'Reference is required.',
      missing_phone:'Phone is required.',
      missing_trial_initial_at:'First meeting date is required.',
      missing_trial_next_at:'Next meeting date is required.',
      missing_note:'Note is required.',
      missing_devices:'Add at least one device with model and price.',
      invalid_device_model:'Each device row needs a model.',
      invalid_device_price:'Device price must be greater than zero.',
      missing_sale_payer:'Select a payer (Kurum) for this trial.'
    };

    fullNameInput.addEventListener('input',()=>{
      const slug=toSlugTrLocal(fullNameInput.value);
      slugPreview.textContent=slug?`Slug: ${slug}`:'';
    });

    function toSlugTrLocal(name){
      const map={"ç":"c","Ç":"c","ğ":"g","Ğ":"g","ı":"i","I":"i","İ":"i","ö":"o","Ö":"o","ş":"s","Ş":"s","ü":"u","Ü":"u","â":"a","Â":"a","î":"i","Î":"i","ê":"e","Ê":"e","ô":"o","Ô":"o","û":"u","Û":"u"};
      let out=''; let prev=true;
      for(const ch of String(name||'')){
        const repl=map[ch]!==undefined?map[ch]:ch.toLowerCase();
        if(/[a-z0-9]/.test(repl)){ out+=repl; prev=false; continue; }
        if(/[\s\-\.+]/.test(ch)){ if(!prev) out+='_'; prev=true; }
      }
      return out.replace(/_+/g,'_').replace(/^_+|_+$/g,'');
    }

    function addDeviceRow(data){
      const tr=document.createElement('tr');

      const modelTd=document.createElement('td');
      const modelInput=document.createElement('input');
      modelInput.type='text';
      modelInput.placeholder='Model';
      modelInput.value=data&&data.model?data.model:'';
      modelInput.setAttribute('data-field','model');
      modelTd.appendChild(modelInput);

      const priceTd=document.createElement('td');
      const priceInput=document.createElement('input');
      priceInput.type='number';
      priceInput.step='0.01';
      priceInput.min='0';
      priceInput.placeholder='Net price';
      priceInput.value=data&&data.price_net?data.price_net:'';
      priceInput.setAttribute('data-field','price');
      priceTd.appendChild(priceInput);

      const actionTd=document.createElement('td');
      actionTd.className='cell-actions';
      const removeBtn=document.createElement('button');
      removeBtn.type='button';
      removeBtn.className='btn-secondary';
      removeBtn.textContent='✕';
      removeBtn.addEventListener('click',()=>{
        tr.remove();
        if(!devicesBody.children.length){ addDeviceRow(); }
      });
      actionTd.appendChild(removeBtn);

      tr.appendChild(modelTd);
      tr.appendChild(priceTd);
      tr.appendChild(actionTd);
      devicesBody.appendChild(tr);
    }

    function submitForm(event){
      event.preventDefault();
      clearToast();
      const {payload,error}=gatherPayload();
      if(error){
        const msg=ERROR_MESSAGES[error.code]||error.message||'Please fix highlighted fields.';
        showToast('err',msg);
        return;
      }
      const validationError=validatePayload(payload);
      if(validationError){
        const msg=ERROR_MESSAGES[validationError]||'Please complete all required fields.';
        showToast('err',msg);
        return;
      }
      submitBtn.disabled=true;
      google.script.run
        .withSuccessHandler(res=>{
          submitBtn.disabled=false;
          if(res && res.ok){
            showToast('ok',`Trial saved • ${res.patient_slug} • ${res.trial_id}`);
            clearVisitFields();
          }else if(res){
            const msg=ERROR_MESSAGES[res.code]||res.message||'Unable to save trial.';
            showToast('err',msg);
          }else{
            showToast('err','Unexpected response from server.');
          }
        })
        .withFailureHandler(err=>{
          submitBtn.disabled=false;
          showToast('err',(err && err.message) ? err.message : 'Unexpected error.');
        })
        .qe_upsertTrialCase(payload);
    }

    function gatherPayload(){
      const person={
        full_name:fullNameInput.value.trim(),
        ref:refInput.value.trim(),
        phone:phoneInput.value.trim(),
        address:addressInput.value.trim()
      };
      const trial={
        initial_at:initialInput.value?new Date(initialInput.value):null,
        next_at:nextInput.value?new Date(nextInput.value):null,
        note:noteInput.value.trim()
      };
      const sale={ payer:payerInput.value.trim() };
      const deviceResult=collectDevices();
      if(deviceResult.error){ return {error:deviceResult.error}; }
      const payload={ person, trial, sale, devices:deviceResult.devices };
      if(!payload.devices.length){ return {error:{code:'missing_devices'}}; }
      return {payload};
    }

    function collectDevices(){
      const rows=[];
      const trs=devicesBody.querySelectorAll('tr');
      for(let i=0;i<trs.length;i++){
        const tr=trs[i];
        const modelInput=tr.querySelector('input[data-field="model"]');
        const priceInput=tr.querySelector('input[data-field="price"]');
        const model=(modelInput?modelInput.value:'').trim();
        const priceValue=(priceInput?priceInput.value:'').trim();
        if(!model && !priceValue){ continue; }
        if(!model){ return {error:{code:'invalid_device_model'}}; }
        const price=Number(priceValue);
        if(!priceValue || !isFinite(price) || price<=0){ return {error:{code:'invalid_device_price'}}; }
        rows.push({model, price_net:price});
      }
      return {devices:rows};
    }

    function validatePayload(payload){
      if(!payload.person.full_name){ return 'missing_full_name'; }
      if(!payload.person.ref){ return 'missing_ref'; }
      if(!payload.person.phone){ return 'missing_phone'; }
      if(!(payload.trial.initial_at instanceof Date) || isNaN(payload.trial.initial_at.getTime())){ return 'missing_trial_initial_at'; }
      if(!(payload.trial.next_at instanceof Date) || isNaN(payload.trial.next_at.getTime())){ return 'missing_trial_next_at'; }
      if(!payload.trial.note){ return 'missing_note'; }
      if(!payload.sale.payer){ return 'missing_sale_payer'; }
      if(!payload.devices.length){ return 'missing_devices'; }
      return null;
    }

    function clearVisitFields(){
      initialInput.value='';
      nextInput.value='';
      noteInput.value='';
      while(devicesBody.firstChild){ devicesBody.removeChild(devicesBody.firstChild); }
      addDeviceRow();
    }

    function showToast(kind,message){
      toast.textContent=message;
      toast.className=kind==='ok'?'toast ok':'toast err';
    }

    function clearToast(){
      toast.textContent='';
      toast.className='toast';
    }

    addDeviceRow();
  </script>
</body>
</html>
